services:
  spam-scanner:
    image: spam-scanner:latest
    build: .
    container_name: spam-scanner
    env_file: .env
    depends_on:
      - rspamd
    restart: unless-stopped
    volumes:
      - ${SPAM_SCANNER_DATA}/rspamd/maps:/data/rspamd/maps
    environment:
      # Hardcode internal Rspamd URL for service-to-service communication
      - RSPAMD_URL=http://rspamd:11334
      # Interpolate password from .env file
      - RSPAMD_PASSWORD=${RSPAMD_PASSWORD}
      # Map paths inside the container (mounted above)
      - RSPAMD_WHITELIST_MAP_PATH=/data/rspamd/maps/whitelist.map
      - RSPAMD_BLACKLIST_MAP_PATH=/data/rspamd/maps/blacklist.map
    networks:
      - spam-network

  rspamd:
    image: rspamd/rspamd:latest
    container_name: rspamd
    ports:
      - "11332:11332"  # Proxy worker
      - "11334:11334"  # Web interface
    volumes:
      - ./rspamd/config:/etc/rspamd/local.d
      - ${SPAM_SCANNER_DATA}/rspamd/data:/var/lib/rspamd
      - ${SPAM_SCANNER_DATA}/rspamd/logs:/var/log/rspamd
      - ${SPAM_SCANNER_DATA}/rspamd/maps:/etc/rspamd/maps
    depends_on:
      - redis
      - unbound
    restart: unless-stopped
    networks:
      - spam-network

  redis:
    image: redis:alpine
    container_name: rspamd-redis
    volumes:
      - ${SPAM_SCANNER_DATA}/redis:/data
    restart: unless-stopped
    networks:
      - spam-network

  unbound:
    image: klutchell/unbound:latest
    container_name: rspamd-unbound
    restart: unless-stopped
    networks:
      - spam-network

networks:
  spam-network:
    driver: bridge
